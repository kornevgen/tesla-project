\section{Алгоритм преобразования тестовых ситуаций в кэше
    в равенство-неравенство адресов}\label{eqs}

Исходными данным для алгоритма является последовательность тестовых
ситуаций в кэш-памяти, относящиеся к одному сету. Для каждой
тестовой ситуации указаны 1-2 тега. Алгоритм транслирует тестовые
ситуации в кэш-памяти в ограничения на множество тегов и упрощает их
до искомых ограничений вида <<равенство-неравенство>> целочисленных
переменных (тегов). Ограничения на множества тегов выражают сущность
тестовой ситуации: кэш-попадание выражается ограничением
принадлежности, кэш-промах -- ограничением непринадлежности.

Более точно, кэш-попадание тега $p$ выражается ограничением $p \in
L$, где $L$ -- текущее множество тегов сета. Кэш-промах тега $p$ при
вытесненном теге $q$ выражается ограничениями $q \in L$, $p \notin
L$, $L' = ( L \setminus \{ q \} ) \cup p$ (смена текущего множества
тегов сета; вначале $L$ есть множество различных переменных-тегов --
начальное состояние сета). Осталось выразить в виде ограничений на
множества \emph{стратегию кэширования} на тег $q$. Далее будет
рассмотрена стратегия кэширования LRU (Least Recently Used), хотя
подобная техника применима и к другим стратегиям кэширования (MRU).
Согласно стратегии кэширования LRU (Least Recently Used) будет
вытеснен тег, к которому дольше всех не было обращений. Иными
словами, с момента последнего обращения к этому тегу (последнего к
нему $hit(p1)$) до момента вытеснения происходят обращения ко всем
остальным тегам сета. Перебором кэш-попаданий в данной
последовательности добавляются ограничения вида $q = s, \{ h_1, h_2,
... h_n \} = L \setminus \{ q \}$, где $s$ -- тег из заданной
последовательности тестовых ситуаций, при обращении к которому
происходит кэш-попадание, а $h_1, h_2, ..., h_n$ -- теги из заданной
подпоследовательности тестовых ситуаций между обращением к $s$ и
вытеснением $q$. К рассматриваемым попаданиям надо добавить теги,
при обращении к которым происходят кэш-промахи (т.к. они добавляются
в сет), и теги, представляющие начальное состояние сета.

С учетом двух следующих замечаний количество ограничений,
описывающих стратегию кэширования LRU, можно уменьшить:
\begin{enumerate}
\item между последним обращениям к $q$ и его вытеснением должно
быть не менее $N - 1$ обращений к тегам, где $N$ -- ассоциативность
кэш-памяти (размер сета)
\item порядок последних обращений к тегам повторяет порядок их
вытеснения
\end{enumerate}

Если схема тестовой программы начинается с последовательности
кэш-промахов, то несложно просчитать без разрешения ограничений,
чему равны вытесняемые теги. Это позволит еще уменьшить размер
системы.

Пример последовательности ситуаций в кэше и соответствующая система:
\begin{verbatim}
 hit x1 //начальное состояние сета
 hit x2 //начальное состояние сета
 hit x3      L = { x1, x2, x3, x4 }
 hit x4 //начальное состояние сета
[ miss x5 -> x6 ]
 hit x5   // добавленный hit
 hit x7      L1 = ( { x1, x2, x3, x4 } \ { x6 } ) \/ { x5 }
[ miss x8 -> x9 ]
\end{verbatim}
и система для 4-х ассоциативной кэш-памяти (ассоциативность равна
размеру сета):
$$
\left\{
    \begin{aligned}
        x1 \notin \{x2, x3, x4\}, x2 \notin \{x3, x4\}, x3 \neq x4\\
        L = \{ x1, x2, x3, x4 \}\\
        x6 \in L\\
        x5 \notin L\\
        L1 = ( L \setminus \{ x6 \} ) \cup \{ x5 \}\\
        \{x7, x9\} \subseteq L1\\
        x8 \notin L1\\
        \\
        \left[
            \begin{aligned}
                \left\{
                    \begin{aligned}
                        x9 = x3\\
                        \{x4, x5, x7\} = L1 \setminus \{ x9 \}\\
                        x6 = x1\\
                        \{x2, x3, x4\} = L \setminus \{ x6 \}\\
                    \end{aligned}
                \right. \\
                \left\{
                    \begin{aligned}
                        x9 = x2\\
                        \{x3, x4, x5, x7\} = L1 \setminus \{ x9 \}\\
                        x6 = x1\\
                        \{x2, x3, x4\} = L \setminus \{ x6 \}\\
                    \end{aligned}
                \right. \\
            \end{aligned}
        \right.
    \end{aligned}
\right.
$$
Решением такой системы могут быть следующие зависимости между
тегами:
$$
\left\{
    \begin{aligned}
    \{ x1, x2, x3, x4, x5 \} - \text{ все разные }\\
    x6 = x1\\
    x7 = x2\\
    x9 = x3\\
    x8 \neq x2, x8 \neq x3, x8 \neq x4, x8 \neq x5\\
    \end{aligned}
\right.
$$
или
$$
\left\{
    \begin{aligned}
    \{ x1, x2, x3, x4, x5 \} - \text{ все разные }\\
    x6 = x1\\
    x7 = x3 \vee x7 = x4 \vee x7 = x5\\
    x9 = x2\\
    x8 \neq x2, x8 \neq x3, x8 \neq x4, x8 \neq x5\\
    \end{aligned}
\right.
$$
