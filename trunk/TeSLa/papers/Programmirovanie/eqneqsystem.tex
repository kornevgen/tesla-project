\section{Алгоритм преобразования тестовых ситуаций в кэше
    в равенство~-~неравенство адресов}\label{eqs}

Исходными данным для алгоритма является последовательность тестовых
ситуаций в кэш-памяти, относящихся к одному сету. Для каждой
тестовой ситуации указаны 1-2 тега (имеющийся тег либо пара
вытесняющий-вытесняемый теги). Алгоритм состоит из двух шагов. На
первом шаге составляются ограничения на конечные множества тегов, а
на втором шаге эти ограничения разрешаются символьно (упрощаются) до
искомых ограничений вида <<равенство-неравенство>> целочисленных
переменных (тегов). Разрешение ограничений можно проводить любым из
известных алгоритмов разрешения ограничений~\cite{ConstrProp}.
Первый же шаг включает в себя сначала генерацию ограничений, исходя
только из самой тестовой ситуации, а затем генерацию ограничений,
формулируемых на весь тестовый шаблон (например, lru). Генерация
осуществляется последовательно для каждой тестовой ситуации.
Ограничения на множества тегов выражают сущность тестовой ситуации:
кэш-попадание выражается ограничением принадлежности, кэш-промах --
ограничением непринадлежности.

Более точно, кэш-попадание тега $p$ выражается ограничением $p \in
L$, где $L$ -- текущее множество тегов сета. Кэш-промах тега $p$ при
вытесненном теге $q$ выражается ограничениями $q \in L$, $p \notin
L$, $L' = ( L \setminus \{ q \} ) \cup \{p\}$ (смена текущего
множества тегов сета; вначале $L$ есть множество различных
переменных-тегов -- начальное состояние сета). Осталось выразить в
виде ограничений на множества \emph{политику замещения} на тег $q$.
Далее будет рассмотрена политика замещения LRU (Least Recently
Used), хотя подобная техника применима и к другим политикам
замещения (MRU). Согласно LRU будет вытеснен тег, к которому дольше
всех не было обращений. Иными словами, с момента последнего
обращения к этому тегу (последнего к нему попаданию) до момента
вытеснения происходят обращения ко всем остальным тегам сета.
Перебором кэш-попаданий по последовательности кэш-попаданий
тестового шаблона добавляются ограничения вида $q = s, \{ h_1, h_2,
... h_n \} = L \setminus \{ q \}$, где $s$ -- очередной тег из
последовательности попаданий, а $h_1, h_2, ..., h_n$ -- теги из той
же последовательности, находящиеся между обращением к $s$ и
вытеснением $q$. К рассматриваемым попаданиям надо добавить теги,
при обращении к которым происходят кэш-промахи (т.к. они добавляются
в сет), и теги, представляющие начальное состояние сета.

С учетом двух следующих замечаний количество ограничений,
описывающих политику замещения LRU, можно уменьшить:
\begin{enumerate}
\item между последним обращениям к $q$ и его вытеснением должно
быть не менее $N - 1$ обращений к любым тегам, где $N$ --
ассоциативность кэш-памяти (размер сета), т.е. размер
последовательности $h_1, h_2, ..., h_n$ не меньше $N - 1$
\item порядок последних обращений к тегам повторяет порядок их
вытеснения
\item последовательность $h_1, h_2, ..., h_n$ не должна проходить
через более, чем  $N$ вытеснений (в противном случае в этой
последовательности обязательно должен был бы появиться вытесняемый
тег)
\end{enumerate}

Если тестовый шаблон начинается с последовательности кэш-промахов,
то несложно просчитать без разрешения ограничений, чему равны
вытесняемые теги. Это позволит еще уменьшить размер системы.

Пример последовательности ситуаций в кэше и соответствующая система:
\begin{verbatim}
 hit x1 //начальное состояние сета
 hit x2 //начальное состояние сета
 hit x3      L = { x1, x2, x3, x4 }
 hit x4 //начальное состояние сета
[ miss x5 -> x6 ]
 hit x5   // добавленный hit
 hit x7      L1 = ( { x1, x2, x3, x4 } \ { x6 } ) \/ { x5 }
[ miss x8 -> x9 ]
\end{verbatim}
и система для 4-х ассоциативной кэш-памяти (ассоциативность равна
размеру сета):
$$
\left\{
    \begin{aligned}
        x1 \notin \{x2, x3, x4\}, x2 \notin \{x3, x4\}, x3 \neq x4\\
        L = \{ x1, x2, x3, x4 \}\\
        x6 \in L\\
        x5 \notin L\\
        L1 = ( L \setminus \{ x6 \} ) \cup \{ x5 \}\\
        \{x7, x9\} \subseteq L1\\
        x8 \notin L1\\
        \\
        \left[
            \begin{aligned}
                \left\{
                    \begin{aligned}
                        x9 = x3\\
                        \{x4, x5, x7\} = L1 \setminus \{ x9 \}\\
                        x6 = x1\\
                        \{x2, x3, x4\} = L \setminus \{ x6 \}\\
                    \end{aligned}
                \right. \\
                \left\{
                    \begin{aligned}
                        x9 = x2\\
                        \{x3, x4, x5, x7\} = L1 \setminus \{ x9 \}\\
                        x6 = x1\\
                        \{x2, x3, x4\} = L \setminus \{ x6 \}\\
                    \end{aligned}
                \right. \\
            \end{aligned}
        \right.
    \end{aligned}
\right.
$$
Решением такой системы могут быть следующие зависимости между
тегами:
$$
\left\{
    \begin{aligned}
    \{ x1, x2, x3, x4, x5 \} - \text{ все разные }\\
    x6 = x1\\
    x7 = x2\\
    x9 = x3\\
    x8 \neq x2, x8 \neq x3, x8 \neq x4, x8 \neq x5\\
    \end{aligned}
\right.
$$
или
$$
\left\{
    \begin{aligned}
    \{ x1, x2, x3, x4, x5 \} - \text{ все разные }\\
    x6 = x1\\
    x7 = x3 \vee x7 = x4 \vee x7 = x5\\
    x9 = x2\\
    x8 \neq x2, x8 \neq x3, x8 \neq x4, x8 \neq x5\\
    \end{aligned}
\right.
$$
