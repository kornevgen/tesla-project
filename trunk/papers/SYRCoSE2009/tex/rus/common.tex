\section{Общий случай}

\begin{figure}[h]
\centering
\includegraphics[width=2.5in]{common}
\caption{Кэш общего вида} \label{common_cache}
\end{figure}

Без объяснений лишь в иллюстративных целях приведу ограничения и их
решение для кэш-памяти общего вида (см. рис~\ref{common_cache}).

Функциональный символ $R(x)$ будет иметь ровно тот же смысл, что и
при кэш-памяти прямого отображения.

Рассмотрим тот же тестовый шаблон для памяти из 3-х регионов ($R(x)
= R(y) \leftrightarrow 3 | (x-y)$) и 2-х ассоциативной кэш-памяти:

LOAD x, y @ Hit

STORE u, z @ Miss

LOAD z, y @ Hit

Вводим аналогично двум предыдущим случаям версии переменных и
фиктивную переменную $z'_0$:

LOAD $x_1, y_0$ @ Hit

STORE $u_0, z_0$ @ Miss $\rightarrow z'_0$

LOAD $z_1, y_0$ @ Hit

Введем переменные для начального состояния кэша: $\alpha_1,
\alpha_2$ для первого региона, $\beta_1, \beta_2$ для второго
региона, $\gamma_1, \gamma_2$ для третьего. Сама система ограничений
будет иметь следующий вид:

$y_0 \in \{ \alpha_1, \alpha_2, \beta_1, \beta_2, \gamma_1, \gamma_2
\}$,

$z'_0 \in \{ \alpha_1, \alpha_2, \beta_1, \beta_2, \gamma_1,
\gamma_2 \}$,

$z_0 \notin \{ \alpha_1, \alpha_2, \beta_1, \beta_2, \gamma_1,
\gamma_2 \} \cap R(z'_0)$,

$y_0 \in \{ \alpha_1, \alpha_2, \beta_1, \beta_2, \gamma_1, \gamma_2
\} \cup \{z_0\} \setminus \{z'_0\}$,

$R(z_0) = R(z'_0)$,

$\alpha_1, \alpha_2, \beta_1, \beta_2, \gamma_1, \gamma_2$ -- все
разные,

$R(\alpha_1) = R(\alpha_2)$,

$R(\beta_1) = R(\beta_2)$,

$R(\gamma_1) = R(\gamma_2)$,

$R(\alpha_1), R(\beta_1), R(\gamma_1)$ -- все разные

И дизъюнкция, описывающая $lru(z'_0)$ (достаточно одного дизъюнкта
для получения решения):

$z'_0 = \gamma_2 \wedge (\{ \alpha_1, \alpha_2, \beta_1, \beta_2,
\gamma_1, \gamma_2 \}\setminus \{z'_0\}) \cap R(z'_0) = \{y_0\} \cap
R(z'_0)$

$\vee$

...

Упрощаем полученную систему ограничений:

$y_0 \in \{ \alpha_1, ..., \gamma_2 \}$,

$z'_0 \in \{ \alpha_1, ..., \gamma_2 \}$,

$z_0 \notin \{ \alpha_1, ..., \gamma_2 \} \cap R(z'_0)$,

$y_0 \in \{ \alpha_1, ..., \gamma_2, z_0 \} \setminus \{z'_0 \}$,

$R(z_0) = R(z'_0)$,

$z'_0 = \gamma_2$,

$\{ \gamma_1 \} = \{ y_0 \} \cap R(\gamma_2)$

$\alpha_1, \alpha_2, \beta_1, \beta_2, \gamma_1, \gamma_2$ -- все
разные,

$R(\alpha_1) = R(\alpha_2)$,

$R(\beta_1) = R(\beta_2)$,

$R(\gamma_1) = R(\gamma_2)$,

$R(\alpha_1), R(\beta_1), R(\gamma_1)$ -- все разные

И окончательное упрощение:

$z'_0 = \gamma_2$,

$y_0 = \gamma_1$,

$z_0 \notin \{ \gamma_1, \gamma_2 \}$,

$R(z_0) = R(\gamma_2)$,

$\alpha_1, \alpha_2, \beta_1, \beta_2, \gamma_1, \gamma_2$ -- все
разные,

$R(\alpha_1) = R(\alpha_2)$,

$R(\beta_1) = R(\beta_2)$,

$R(\gamma_1) = R(\gamma_2)$,

$R(\alpha_1), R(\beta_1), R(\gamma_1)$ -- все разные

Разрешая эти ограничения для 8-битных адресов, можно получить такое
решение:

$\alpha_1 = 0, \alpha_2 = 3$,

$\beta_1 = 1, \beta_2 = 4$,

$\gamma_1 = 2, \gamma_2 = 5$,

$x_0 = 0, y_0 = 2, z_0 = 7, u_0 = 0$ .

В общем случае для символьного решения подобного рода систем
ограничений (с операциями над множествами) могут применяться
специальные алгоритмы разрешения на основе того, что все множества
конечные (достаточно рассматривать $R(x)$ как множество лишь тех
адресов, к которым обращаются инструкции тестового шаблона).
